// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}
 enum UserRole {
  ADMIN
  MANAGER
  CASHIER
  WAITER
}

enum OrderStatus {
  OPEN
  CLOSED
  CANCELED
}

enum OrderItemStatus {
  SENT
  PREPARING
  DONE
  CANCELED
}

enum PaymentMethod {
  CASH
  PIX
  CARD
  OTHER
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  CANCELED
}

enum CashRegisterStatus {
  OPEN
  CLOSED
}

enum CashMovementType {
  SALE
  SUPPLY
  WITHDRAW
  ADJUSTMENT
}

enum InventoryMovementType {
  IN
  OUT
  LOSS
  ADJUSTMENT
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      UserRole
  active    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  ordersOpened Order[] @relation("OrdersOpened")
  cashRegisters CashRegister[]
}

model Product {
  id        String   @id @default(uuid())
  name      String
  price     Decimal  @db.Decimal(12,2)
  category  String?
  active    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  orderItems OrderItem[]
  recipes    ProductRecipe[]
}

model Order {
  id        String      @id @default(uuid())
  number    Int
  table     String?
  status    OrderStatus @default(OPEN)

  openedAt  DateTime    @default(now())
  closedAt  DateTime?

  openedById String
  openedBy   User @relation("OrdersOpened", fields: [openedById], references: [id])

  items     OrderItem[]
  sale      Sale?

  @@index([status])
}

model OrderItem {
  id         String          @id @default(uuid())
  orderId    String
  productId  String

  quantity   Int
  unitPrice  Decimal         @db.Decimal(12,2)
  status     OrderItemStatus @default(SENT)

  createdAt  DateTime @default(now())
  canceledAt DateTime?

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model Sale {
  id          String   @id @default(uuid())
  orderId     String   @unique
  totalAmount Decimal  @db.Decimal(12,2)
  discount    Decimal  @db.Decimal(12,2) @default(0)
  finalAmount Decimal  @db.Decimal(12,2)

  createdAt   DateTime @default(now())

  order    Order     @relation(fields: [orderId], references: [id])
  payments Payment[]
}

model Payment {
  id        String        @id @default(uuid())
  saleId    String
  method    PaymentMethod
  amount    Decimal       @db.Decimal(12,2)
  status    PaymentStatus @default(PENDING)
  reference String?

  createdAt DateTime @default(now())

  sale Sale @relation(fields: [saleId], references: [id])

  @@index([saleId])
}

model CashRegister {
  id            String             @id @default(uuid())
  status        CashRegisterStatus @default(OPEN)
  openingAmount Decimal            @db.Decimal(12,2)
  closingAmount Decimal            @db.Decimal(12,2)

  openedAt DateTime @default(now())
  closedAt DateTime?

  openedById String
  openedBy   User @relation(fields: [openedById], references: [id])

  movements CashMovement[]
}

model CashMovement {
  id             String            @id @default(uuid())
  cashRegisterId String
  type           CashMovementType
  method         PaymentMethod?
  amount         Decimal           @db.Decimal(12,2)
  referenceId    String?

  createdAt DateTime @default(now())

  cashRegister CashRegister @relation(fields: [cashRegisterId], references: [id])
}

model InventoryItem {
  id        String   @id @default(uuid())
  name      String
  unit      String
  active    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  movements InventoryMovement[]
  recipes   ProductRecipe[]
}


model InventoryMovement {
  id              String                @id @default(uuid())
  inventoryItemId String
  type            InventoryMovementType
  quantity        Decimal               @db.Decimal(12,3)
  reason          String?

  createdAt DateTime @default(now())

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@index([inventoryItemId])
}


model ProductRecipe {
  id              String   @id @default(uuid())
  productId       String
  inventoryItemId String
  quantityUsed    Decimal  @db.Decimal(12,3)

  product        Product        @relation(fields: [productId], references: [id])
  inventoryItem  InventoryItem  @relation(fields: [inventoryItemId], references: [id])

  @@unique([productId, inventoryItemId])
}
