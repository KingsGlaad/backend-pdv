generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String              @id @default(uuid())
  name                 String
  email                String              @unique
  password             String
  role                 UserRole            @default(CASHIER)
  active               Boolean             @default(true)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  deletedAt            DateTime?
  drawerLogs           CashDrawerLog[]
  cashSessions         CashSession[]       @relation("OperatorSessions")
  inventoryMovirements InventoryMovement[]
  ordersOpened         Order[]             @relation("OrdersOpened")
  sales                Sale[]
}

model Product {
  id             String          @id @default(uuid())
  name           String
  price          Decimal         @db.Decimal(12, 2)
  category       String?
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  code           String          @unique
  description    String?
  imageUrl       String?
  inventoryItems InventoryItem[]
  orderItems     OrderItem[]
}

model Order {
  id         String      @id @default(uuid())
  number     Int
  table      String?
  status     OrderStatus @default(OPEN)
  openedAt   DateTime    @default(now())
  closedAt   DateTime?
  openedById String
  createdAt  DateTime    @default(now())
  saleId     String?
  openedBy   User        @relation("OrdersOpened", fields: [openedById], references: [id])
  sale       Sale?       @relation(fields: [saleId], references: [id])
  items      OrderItem[]

  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String?
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  saleId    String?
  order     Order?  @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
  sale      Sale?   @relation(fields: [saleId], references: [id], onDelete: Cascade)
}

model Sale {
  id            String       @id @default(uuid())
  discount      Decimal?     @db.Decimal(10, 2)
  createdAt     DateTime     @default(now())
  cashSessionId String?
  code          String       @unique @default(cuid())
  customerCpf   String?
  paymentMethod String
  total         Decimal      @db.Decimal(10, 2)
  userId        String?
  finalAmount   Decimal      @db.Decimal(10, 2)
  status        SaleStatus   @default(COMPLETED)
  orders        Order[]
  items         OrderItem[]
  payments      Payment[]
  cashSession   CashSession? @relation(fields: [cashSessionId], references: [id])
  user          User?        @relation(fields: [userId], references: [id])
}

model Payment {
  id             String        @id @default(uuid())
  saleId         String
  method         PaymentMethod
  amount         Decimal       @db.Decimal(12, 2)
  status         PaymentStatus @default(PENDING)
  reference      String?
  createdAt      DateTime      @default(now())
  cashMovementId String?
  cashMovement   CashMovement? @relation(fields: [cashMovementId], references: [id])
  sale           Sale          @relation(fields: [saleId], references: [id])

  @@index([saleId])
}

model CashRegister {
  id        String          @id @default(uuid())
  name      String          @unique
  createdAt DateTime        @default(now())
  isActive  Boolean         @default(true)
  logs      CashDrawerLog[]
  sessions  CashSession[]
}

model CashSession {
  id             String         @id @default(uuid())
  cashRegisterId String
  openedAt       DateTime       @default(now())
  closedAt       DateTime?
  difference     Decimal?       @db.Decimal(10, 2)
  finalBalance   Decimal?       @db.Decimal(10, 2)
  initialBalance Decimal        @db.Decimal(10, 2)
  systemBalance  Decimal?       @db.Decimal(10, 2)
  userId         String
  status         String         @default("OPEN")
  movements      CashMovement[]
  cashRegister   CashRegister   @relation(fields: [cashRegisterId], references: [id])
  user           User           @relation("OperatorSessions", fields: [userId], references: [id])
  sales          Sale[]
}

model CashMovement {
  id        String           @id @default(uuid())
  amount    Decimal          @db.Decimal(10, 2)
  createdAt DateTime         @default(now())
  reason    String?
  sessionId String
  type      CashMovementType
  session   CashSession      @relation(fields: [sessionId], references: [id])
  payments  Payment[]
}

model CashDrawerLog {
  id             String       @id @default(uuid())
  description    String?
  createdAt      DateTime     @default(now())
  action         String
  cashRegisterId String
  userId         String
  cashRegister   CashRegister @relation(fields: [cashRegisterId], references: [id])
  user           User         @relation(fields: [userId], references: [id])
}

model InventoryItem {
  id        String              @id @default(uuid())
  updatedAt DateTime            @updatedAt
  minStock  Int                 @default(5)
  quantity  Int                 @default(0)
  productId String
  product   Product             @relation(fields: [productId], references: [id])
  movements InventoryMovement[]
}

model InventoryMovement {
  id              String        @id @default(uuid())
  inventoryItemId String
  quantity        Int
  reason          String?
  createdAt       DateTime      @default(now())
  userId          String
  type            String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  user            User          @relation(fields: [userId], references: [id])
}

model Config {
  id                String   @id @default(uuid())
  appName           String   @default("PDV App")
  logoUrl           String?
  theme             String   @default("system")
  currency          String   @default("BRL")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  address           String?
  cnpj              String?
  companyName       String?
  email             String?
  phone             String?
  stateRegistration String?
  tradingName       String?
}

model PrinterConfig {
  id          String   @id @default(uuid())
  terminalId  String   @unique
  name        String?
  printerName String
  printerType String
  connection  String
  width       Int      @default(80)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum UserRole {
  ADMIN
  MANAGER
  CASHIER
  WAITER
}

enum OrderStatus {
  OPEN
  CLOSED
  CANCELED
}

enum OrderItemStatus {
  SENT
  PREPARING
  DONE
  CANCELED
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELED
}

enum PaymentMethod {
  CASH
  PIX
  CARD
  OTHER
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  CANCELED
}

enum CashRegisterStatus {
  OPEN
  CLOSED
}

enum CashMovementType {
  SALE
  SUPPLY
  WITHDRAW
  ADJUSTMENT
}

enum DrawerOpenReason {
  SALE
  MANUAL
  ERROR
}

enum InventoryMovementType {
  IN
  OUT
  LOSS
  ADJUSTMENT
}

enum ProductUnit {
  UNIT
  GRAM
  KILOGRAM
  LITER
  MILLILITER
}
