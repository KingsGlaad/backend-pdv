generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String    @id @default(uuid())
  name      String
  email     String    @unique
  password  String
  role      UserRole  @default(CASHIER)
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  ordersOpened         Order[]             @relation("OrdersOpened")
  cashSessions         CashSession[]       @relation("OperatorSessions")
  drawerLogs           CashDrawerLog[]
  sales                Sale[]
  inventoryMovirements InventoryMovement[]
}

model Product {
  id          String    @id @default(uuid())
  code        String    @unique
  name        String
  price       Decimal   @db.Decimal(12, 2)
  description String?
  category    String?
  imageUrl    String?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  orderItems     OrderItem[]
  inventoryItems InventoryItem[]
}

model Order {
  id        String      @id @default(uuid())
  number    Int
  table     String?
  status    OrderStatus @default(OPEN)
  openedAt  DateTime    @default(now())
  closedAt  DateTime?
  createdAt DateTime    @default(now())

  openedById String
  openedBy   User   @relation("OrdersOpened", fields: [openedById], references: [id])

  items  OrderItem[]
  sale   Sale?       @relation(fields: [saleId], references: [id])
  saleId String?

  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id        String  @id @default(uuid())
  saleId    String?
  sale      Sale?   @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal @db.Decimal(10, 2) // Preço no momento da venda (snapshot)
  order     Order?  @relation(fields: [orderId], references: [id])
  orderId   String?
}

model Sale {
  id            String     @id @default(uuid())
  code          String     @unique @default(cuid()) // Código legível da venda
  total         Decimal    @db.Decimal(10, 2)
  discount      Decimal?   @db.Decimal(10, 2)
  finalAmount   Decimal    @db.Decimal(10, 2)
  paymentMethod String // money, credit, debit, pix
  status        SaleStatus @default(COMPLETED) // COMPLETED, CANCELED
  customerCpf   String?
  createdAt     DateTime   @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Importante: Vincula a venda à sessão do caixa atual
  cashSessionId String?
  cashSession   CashSession? @relation(fields: [cashSessionId], references: [id])

  items    OrderItem[]
  orders   Order[]
  payments Payment[]
}

model Payment {
  id        String        @id @default(uuid())
  saleId    String
  method    PaymentMethod
  amount    Decimal       @db.Decimal(12, 2)
  status    PaymentStatus @default(PENDING)
  reference String?
  createdAt DateTime      @default(now())

  cashMovementId String?
  cashMovement   CashMovement? @relation(fields: [cashMovementId], references: [id])

  sale Sale @relation(fields: [saleId], references: [id])

  @@index([saleId])
}

model CashRegister {
  id        String   @id @default(uuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  sessions CashSession[]
  logs     CashDrawerLog[]
}

model CashSession {
  id             String       @id @default(uuid())
  cashRegisterId String
  cashRegister   CashRegister @relation(fields: [cashRegisterId], references: [id])
  userId         String
  user           User         @relation("OperatorSessions", fields: [userId], references: [id])

  openedAt DateTime  @default(now())
  closedAt DateTime?

  // Valores Monetários
  initialBalance Decimal  @db.Decimal(10, 2) // Fundo de troco inicial
  finalBalance   Decimal? @db.Decimal(10, 2) // Valor contado fisicamente
  systemBalance  Decimal? @db.Decimal(10, 2) // Valor esperado pelo sistema (Vendas + Entradas - Saídas)
  difference     Decimal? @db.Decimal(10, 2) // Quebra de caixa (Final - Sistema)

  status String @default("OPEN") // OPEN, CLOSED

  movements CashMovement[]
  sales     Sale[] // Vendas realizadas nesta sessão
}

model CashMovement {
  id        String      @id @default(uuid())
  sessionId String
  session   CashSession @relation(fields: [sessionId], references: [id])

  type      CashMovementType // SUPPLY (Suprimento), BLEED (Sangria)
  amount    Decimal          @db.Decimal(10, 2)
  reason    String?
  createdAt DateTime         @default(now())
  payments  Payment[]
}

model CashDrawerLog {
  id             String       @id @default(uuid())
  cashRegisterId String
  cashRegister   CashRegister @relation(fields: [cashRegisterId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  action      String // OPEN, CLOSE, SUPPLY, BLEED, FORCE_CLOSE
  description String? // Detalhes legíveis (ex: "Fechado com diferença de -R$10")
  createdAt   DateTime @default(now())
}

model InventoryItem {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int      @default(0)
  minStock  Int      @default(5)
  updatedAt DateTime @updatedAt

  movements InventoryMovement[]
}

model InventoryMovement {
  id              String        @id @default(uuid())
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  type            String // ENTRY (Entrada), EXIT (Saída), ADJUSTMENT (Ajuste)
  quantity        Int
  reason          String?
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  createdAt       DateTime      @default(now())
}

model Config {
  id       String  @id @default(uuid())
  appName  String  @default("PDV App")
  logoUrl  String?
  theme    String  @default("system")
  currency String  @default("BRL")

  // Company Info
  companyName       String?
  tradingName       String?
  cnpj              String?
  stateRegistration String?
  phone             String?
  email             String?
  address           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model PrinterConfig {
  id          String   @id @default(uuid())
  terminalId  String   @unique
  name        String? // Friendly name
  printerName String // System printer name
  printerType String // 'THERMAL', 'A4'
  connection  String // 'USB', 'NETWORK', 'WINDOWS_DRIVER'
  width       Int      @default(80)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum UserRole {
  ADMIN
  MANAGER
  CASHIER
  WAITER
}

enum OrderStatus {
  OPEN
  CLOSED
  CANCELED
}

enum OrderItemStatus {
  SENT
  PREPARING
  DONE
  CANCELED
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELED
}

enum PaymentMethod {
  CASH
  PIX
  CARD
  OTHER
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  CANCELED
}

enum CashRegisterStatus {
  OPEN
  CLOSED
}

enum CashMovementType {
  SALE
  SUPPLY
  WITHDRAW
  ADJUSTMENT
}

enum DrawerOpenReason {
  SALE
  MANUAL
  ERROR
}

enum InventoryMovementType {
  IN
  OUT
  LOSS
  ADJUSTMENT
}

enum ProductUnit {
  UNIT
  GRAM
  KILOGRAM
  LITER
  MILLILITER
}
